
  04 Mar 2011

   Контроллер системы учета отпуска нефтепродуктов.

        Контроллер поддерживает протокол обмена Modbus RTU для подчиненного
   (Slave) устройства , т.е. отвечает на запросы посланные Host.
      Поддерживаются функции Modbus: 3,6,16.
      Контроллеру присвоен собственный адрес в магистрали Modbus.
      Параметры асинхронного последовательного канала связи :
       19200 бод, 8 бит данных, без контроля четности, 1 стоп.бит.
       Физический канал связи RS485.


    В контроллере используется 2 типа регистров:
     - целочисленные (16 бит), далее Int;
     - регистры с плавающей запятой формата IEEE (32 бита), далее Float.


   Регистры типа Int имеют адреса 0...37 .
    Один регистр типа Int (16 бит) занимает один адрес в адресном пространстве.
   Соответственно обозначаются I0...I37. Например:

      I7   Регистр команды
      I8   Регистр состояния
      I10  Регистр ошибок

     Регистры типа Float (32 бита) имеют адреса 1000...1058 .
  Один регистр типа Float занимает 2 адреса в адресном пространстве.
     Соответственно обозначаются F1000...F1058.
   Для пересылки регистр Float разбивается на 2 регистра по 16 бит.
     Сначала передается младший регистр (D0-D15), затем старший (D16-D31).
   В 16 битном регистре, согласно Modbus, первым передаетя старший байт.

  Данные регистров  доступны по чтению - функция Modbus 03 и записи
   - функции Modbus 06,16.

   Поддерживаются функции Modbus: 3,6,16.

  Список регистров Int

Адрес       Описание регистра

 I0      количество регистров типа  int
 I1      количество регистров типа  float

 I2      Переключатель меню ВРФ.
 I3      Переключатель процесса отпуска.

 I4       Версия ПО ,  6 ASCII символов
 I5       Версия ПО
 I6       Версия ПО

 I7       CMD_REG  - регистр команды, в него записывается команда, см. ниже

 I8       Состояние отпуска
          -1 - ошибка при приеме команды старта отпуска
           0 - отпуск остановлен до нажатия кнопки "Пуск"
           1 - команда старта отпуска принята успешно,
                 ожидание нажатия кнопки "Пуск".
           2 - отпуск в процессе выполнения
           5 - останов отпуска (клапаны закрыты), ожидание прекращения потока
          10 - отпуск завершен

 I9       Код последнего события записанного в журнал
I10       Регистр ошибки краткий, 0 - OK

I11       Код ошибки функционирования (см.ниже)
I12       Расширение кода ошибки функционирования (см.ниже)

I13       регистр ошибок драйвера MVD   ( расходомер Micro Motion)
I14       регистр ошибок драйвера 7060  ( дискретный ввод-вывод)
I15       регистр ошибок драйвера 7017  ( аналоговый ввод)
I16       регистр ошибок драйвера DELTA ( электропривод насоса)

I17       Период сторожевого таймера Host,ms
          0 - таймер отключен
I18
I19       подтверждение старта без кнопки = Strt_cmd(0x55=85d)
I20

I21      регистр дискр.входов
I22      регистр дискр.выходов

-----------------------------------
          Переменные привода DELTA

I23      регистр состояния DELTA
I24      регистр ошибок привода DELTA
I25      ток в моторе

I26      тек.знач. частоты  привода  ,0.01 Гц
I27      тек.знач. времени разгона   ,0.1 сек
I28      тек.знач. времени замедления,0.1 сек

I29      нач.знач. частоты привода  , 0.01 Гц
I30      нач.знач. времени разгона  ,  0.1 сек
I31      нач.знач. времени замедления ,0.1 сек
---------------------------------------
I32      резерв
         // регистры 7060

I33       Выходы 7060 (дискретные выходы)
I34       Входы  7060 (дискретные входы)
I35      регистр ошибки расходомера Micro Motion (регистр I419 , p.148 ).
I36      тип нефтепродукта  1 - товарная нефть, 2 - дизтопливо
                 3 - реактивное топливо, 4 - керосин
                 5 - бензин, 6 - смазочное масло

I37       резерв
                
===============================================================================

Регистры Float. Адреса в магистрали : 1000 ...
                Один регистр занимает 2 адреса.
                F1000 ...Fxxxx

Адрес       Описание регистра

F1000    операнд команды
F1002    копия операнда

F1004    объем цистерны до уровня погружения рукава,л

F1006    минимальное давление МПа, при котором возможно увеличить степень
         открытия вентиля

         Результат отпуска дополнительный:

F1008    Референсная температура,C (15)
F1010    Плотность отпущенного нефтепродукта, приведенная к референсной
           температуре
F1012    Объем отпущенного нефтепродукта, приведенный к референсной
        температуре


         Результат отпуска для накладной (обязательные данные):

F1014    Температура отпущенного нефтепродукта
F1016    Плотность отпущенного нефтепродукта

F1018    резервная переменная

         Данные из расходомера
                                                                  Регистр
                                                                 Micro Motion
F1020     Масса инвентарная ( накапливающий счетчик) Mass inventory ,I263
F1022     Масса в текущей операции отпуска (total)   Mass total     ,I259
F1024     Массовый расход, кг/ч                      Mass flow      ,I247
F1026     Плотность кг/м3                            Density        ,I249
F1028     Температура,C                              Temperature    ,I251
F1030     Объем инвентарный ( накапливающий счетчик) Volume invntory,I265
F1032     Объем в текущей операции отпуска (total)
F1034     Объемный расход, л/ч
F1036     Резерв

          Данные аналоговых датчиков

F1038     температура по внешнему датчику, C
F1040     давление по внешнему датчику, МПа

F1042     Заданное давление 10000 = 1 МПа 3200             p1.DP=0.3200
F1044     Частота насоса max, Гц          640000  = 50 Hz, p3.LP=5000
F1046     Частота насоса min, Гц          128000  = 10 Hz, p4.LP=1000
F1048     Расход начальный, л/с           10000            p2.FP=10000
F1050     Расход номинальный, л/с         100000           p3.FP=100000
F1052     Расход замедления  , л/с        3600             p2.FPM=3600
F1054     Расход замедления 1, л/с        7200             p4.FPM=7200
F1056     Расход замедления 2, л/с        15000            p6.FPM=15000
F1058     Частота обмена по Modbus, бод   19200            p1.CMS=19200
          I0007 = 7; - установить частоту, после изменения F1058
=============================================

 Перечень команд .

  Для старта команды , необходимо записать код команды в регистр
 команды (I7) , т.е.  по адресу 07.

 Код команды

       1       Старт отпуска.

       2       Останов отпуска.

       3       Аварийный останов отпуска - мгновенное  обесточивание клапанов
                и мотора насоса.
       4       Сброс контроллера (аналогичен выкл. и затем вкл.)
       5       Сброс ошибок контроллера.
       6       Запись параметров контроллера в EEPROM.
               Все сохраняемые параметры записываются в EEPROM,
             в том числе значение регистра с адресом 32.
        7      установить скорость обмена по Modbus согласно F1058
       17      перейти в режим командной строки

=========================================

     Состояние сигналов датчиков и аварийной кнопки доступно в регистре I21,
  соответствие бит сигналам  см.ниже.


    До старта команды отпуска, объем отпуска в литрах должен быть записан в регистр
  операнда - по адресу 1000 (F1000), тип float.


     После приема команды отпуска,т.е. записи значения 1 в регистр с адресом 07
    ( I7=1;)

     значение регистра операнда переписывается
  в регистр копии операнда с адресом 1002 - (F1002), регистр операнда
  обнуляется.    F1002=F1000; F1000=0;

     Состояние процесса отпуска содержится в регистре с адресом 8 (I8).
   (См.выше).

     Отпуск начнется после приема команды старта отпуска,  при нажатии
  на кнопку "Пуск".

     Для имитации нажатия кнопки "Пуск"  (для отладки, например),
  следует записать в регистр с адресом 19  подтверждение старта без
  кнопки - значение 0x55 (85d). I19=0x55;
    При этом произойдет однократный  запуск процесса отпуска.


     Текущее количество нефтепродукта, отпущенного в данной операции содержится
  в регистрах  F1022, F1032 (см.выше) :

 1022     Масса в текущей операции отпуска (total)
 1032     Объем в текущей операции отпуска (total)

     Текущие состояния процесса отпуска - непосредственные данные
 из расходомера  :

 1020     Масса инвентарная ( накапливающий счетчик) 
 1022     Масса в текущей операции отпуска (total)   
 1024     Массовый расход, кг/ч                      
 1026     Плотность кг/м3                            
 1028     Температура,C                              
 1030     Объем инвентарный ( накапливающий счетчик) 
 1032     Объем в текущей операции отпуска (total)
 1034     Объемный расход, л/ч

          Данные аналоговых датчиков
 1038     температура по внешнему датчику, C
 1040     давление по внешнему датчику, МПа

    После завершения отпуска (I8 == 10):

    Фактически отпущенное количество нефтепродукта в данной операции
 содержится в регистрах  F1022, F1032
 1022     Масса, кг
 1032     Объем, л

  Результирующее значение средней плотности и средней температуры отпущенного
 нефтепродукта содержится в регистрах  1014,1016.

 1014    Температура отпущенного нефтепродукта, C
 1016    Плотность отпущенного нефтепродукта, кг/м3.

  Дополнительные данные в регистрах 1008,1010,1012 :

 1008    Референсная температура,C (15)
 1010    Плотность отпущенного нефтепродукта, приведенная к референсной
           температуре
 1012    Объем отпущенного нефтепродукта, приведенный к референсной
        температуре

=====================================================================================

 Кодировка ошибок функционирования:

    Битовая кодировка регистра ошибок I10:

    При наличии ошибки соответствующий бит устанавливается.
    I10 == 0 - ошибок нет.

       D0...D3 - ошибка, биткодированная по модулям
          D0 - Расходомер
          D1 - Модуль дискретного ввода-вывода N1 (I7044)
          D2 - Модуль аналогового ввода-вывода N2 (I7017)
          D3 - Другие модули

         D4...D15 - ошибка функционирования,
          биткодированная:
        0x0010 - нет сигнала УЗА при отпуске
        0x0020 - консоль не в рабочем положении
        0x0040 - трап не в рабочем положении
        0x0080 - не корректрный ID процессора
        0x0100  - зафиксирован предельный уровень в бензовозе при отпуске.
        0x0200  - нажата аварийная кнопка
        0x0400 - логическая ошибка связи с расходомером
        0x0800 - ошибка при конфигурирования расходомера
        0x1000 - ошибка контрольной суммы EEPROM
        0x2000 - ошибка записи во FLASH
        0x4000 - таймаут связи с базой ( таймаут по приему команды)
        0x8000 - прочие ошибки.

---------------------------
    Битовая кодировка регистра ошибок I11:

   0x1             Ошибка CRC EEPROM процессора
   0x2             Ошибка стирания FLASH
   0x4             Ошибка записи во FLASH
   0x8             Расходомер не заполнен -- здесь не используется
   0x10            Расходомер не обнулил массу/объем
   0x20            Нет обновл.данных для журнала
   0x40            При старте налива зафиксирована утечка до открывания
                   отсечного клапана
   0x80            Насос не развивает давление
   0x000           Насос отключен при отпуске
   0x200           Сторожевой таймер HOST
   0x400           Поток прекратился
   0x800           Нажата аварийная кнопка (ES) при отпуске
   0x2000          Нет связи с расходомером
   0x4000          Ошибка конфигурирования расходомера при включении
   0x0100          Ошибка привода насоса при торможении
   0x0201          Останов привода насоса при отпуске
   0x101           Авария от HOST
   0x401           Драйверы MVD,7060 не включены

При  I11=1000,
    I12:
         2         Нет УЗА при отпуске
         3         Уровень в автоцистерне выше допустимого
         6         Консоль не в раб.позиции
         7         Трап не в раб.позиции
         8         Некорректный ID процессора


I13...I16  Для соответствующих периферийных устройств:
   1               Ошибка чтения устройства
   2               Ошибка записи в устройство
   4               Ошибка Watch Dog
   8               Ошибка в устройстве, код ошибки устройства в старшем байте


---------------------------------

 I21 - регистр дискретных входов , соответствие бит сигналам:

D0   - датчик уровня,   1 - ok
D1   - УЗА,             1 - ok
D2   - кнопка "Start",  1 - кнопка нажата
D3   - Аварийная кнопка 0 - кнопка нажата, 1 - ok
D4   - консоль,         1 - ok
D5   - трап,            1 - ok
D6 = 0
D7 = 1

   В состоянии установки готовом к отпуску значение I21 = 0xbb;
   Если какой-либо из битов = 0 при получении команды "старт отпуска",
 будет установлена соответствующая ошибка , и состояние I=-1;
   При этом соответствующее сообщение будет выведено на дисплей ВРФ.

---------------------------------
